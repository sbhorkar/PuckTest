<html>
 <head>
  <title style="color: #252627;">PetBit Dashboard üêæ</title>
  <meta name="viewport" content="width=620, initial-scale=1">
 </head>
 <body style="width:620px;height:450px">
  <link href="https://espruino.github.io/TinyDash/tinydash.css" rel="stylesheet">
  <script src="https://espruino.github.io/TinyDash/tinydash.js"></script>
  <script src="https://www.puck-js.com/puck.js"></script>  
  <script>
   daily_gridy = 50;
   day = 0;

   function arrayToHoursLabel(data) {
       if (data.length !== 24) {
        throw new Error('Array must contain exactly 24 elements.');
       }
   
       return data.map((value, index) => {
           if (value !== 0) {
               // Apply AM/PM formatting based on the index
               if (index <= 12) {
                   return index === 0 ? `12am : ${value}` : `${index}am : ${value}`; // Special handling for midnight as 12 AM
               } else {
                   return `${index - 12}pm : ${value}`;
               }
           }
           return null;
       }).filter(item => item !== null).join(', ');
   }   

   function formatWeekData(data, currentDayIndex) {
       if (data.length !== 7) {
           throw new Error('Array must contain exactly 7 elements.');
       }
   
       const today = new Date();
       const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       let results = [];
   
       for (let index = 0; index <= currentDayIndex; index++) {
           // Calculate the date for each entry
           let dateOfEntry = new Date(today);
           dateOfEntry.setDate(today.getDate() - (currentDayIndex - index));
   
           // Format the date as "MON-DD"
           let month = months[dateOfEntry.getMonth()]; // Use the array to get the month abbreviation
           let day = dateOfEntry.getDate();
           let dateString = `${month}-${day.toString().padStart(2, '0')}`;
   
           results.push(`${dateString}: ${data[index]}`);
       }
   
       return results.join(', ');
   }
   
   function updateDay() {
    Puck.eval("day", function(d) {
         day = d;
         console.log('Day' + day);
      });
   } 

   function updateBat() {
     Puck.eval("{bat:E.getBattery()}", function(d, err) {
         elements.bat.setValue(d.bat);
     });
   }
   function getActivity() {
      Puck.eval("active_min", function(d) {
         elements.activity.setValue(d);
      });

    //Puck.eval('Puck.getTemperature()', function(temp) {
    //    tempInF = (temp.toFixed(2) * (9/5)) + 32;
    //    elements.temperature.setValue(tempInF);
    //});
    
    Puck.eval("steps", function(d) {
       elements.steps.setValue(d);
    });
    
    Puck.eval("daily_average", function(avg) {
        elements.daily_avg.setValue(avg);
    });

    Puck.eval("daily_average_active_mins", function(avg) {
        elements.daily_avg_mins.setValue(avg);
    });
    
    Puck.eval("seven_day_steps", function(daily_s) {
         elements.daily_steps.setData(daily_s);
        // console.log(formatWeekData(daily_s, day-1));
         elements.daily_label.setValue(formatWeekData(daily_s, day-1));
       });

     Puck.eval("seven_day_active_mins", function(daily_s) {
         elements.daily_active_mins.setData(daily_s);
         //console.log(formatWeekData(daily_s, day-1));
         elements.daily_mins_label.setValue(formatWeekData(daily_s, day-1));
       });

     Puck.eval("hourly_steps", function(daily_s) {
         elements.hourly_steps.setData(daily_s);
        //console.log(arrayToHoursLabel(daily_s));
         elements.hourly_label.setValue(arrayToHoursLabel(daily_s));
       });

   }
   
   function connectDevice() {
    // connect, and ask for the battery percentage
    Puck.eval("{bat:E.getBattery()}", function(d, err) {
          if (!d) {
           alert("Web Bluetooth connection failed!\n"+(err||""));
           return;
          }
          // remove the 'connect' window
          elements.modal.remove();
          elements.bat.setValue(d.bat);
     
          updateDay();
          // getSteps();
          setInterval(getActivity, 2000);
          setInterval(updateDay, 1000*60*60*24);
          setInterval(updateBat, 1000*60);
      });
   }
   // Set up the controls we see on the screen    
   var elements = {
    heading : TD.label({x:10,y:10,width:390,height:50,label:"PetBit Dashboard üêæ"}),
    steps : TD.gauge({x:10,y:70,width:190,height:220,label:"Today's Steps",value:0,min:0,max:10000}),
    activity : TD.gauge({x:210,y:70,width:190,height:220,label:"Today's Active Minutes",value:0,min:0,max:1440}),
    daily_avg : TD.gauge({x:410,y:70,width:190,height:220,label:"Daily Average Steps",value:0,min:0,max:1440}),
    daily_avg_mins : TD.gauge({x:610,y:70,width:190,height:220,label:"Daily Average Minutes",value:0,min:0,max:1440}),
    bat : TD.value({x:410,y:10,width:100,height:50,label:"Battery %",value:0}),
    hourly_steps : TD.graph({x:10,y:300,width:800,height:300,label:"Hourly Steps", gridy:daily_gridy}), 
    hourly_label: TD.value({x:10,y:600,width:800,height:50,label:"Hourly Steps", value:""}),
    daily_steps : TD.graph({x:10,y:650,width:400,height:300,label:"Daily Steps", gridy:daily_gridy}),
    daily_label: TD.value({x:10,y:950,width:400,height:50,label:"Daily Steps", value:"" }),
    daily_active_mins : TD.graph({x:410,y:650,width:400,height:300,label:"Daily Active Minutes", gridy:daily_gridy}),
    daily_mins_label: TD.value({x:410,y:950,width:400,height:50,label:"Daily Active Minutes", value:" "}),
    //temperature : TD.value({x:210,y:300,width:190,height:50,label:"Temperature ¬∞F",value:0}),
    modal : TD.modal({x:10,y:10,width:600,height:350,label:"Click to connect",onchange:connectDevice})
  }

   // Add a comment
   for (var i in elements)
    document.body.appendChild(elements[i]);
  </script>
 </body>
</html>
