<html>
 <head>
  <title style="color: #252627;">PetBit Dashboard üêæ</title>
  <meta name="viewport" content="width=620, initial-scale=1">
 </head>
 <body style="width:620px;height:450px">
  <link href="https://espruino.github.io/TinyDash/tinydash.css" rel="stylesheet">
  <script src="https://espruino.github.io/TinyDash/tinydash.js"></script>
  <script src="https://www.puck-js.com/puck.js"></script>  
  <script>
   daily_steps_gridy = 50;
   function getActandTemp() {
  
    Puck.eval("active_min", function(d) {
       elements.activity.setValue(d);
    });

    Puck.eval('Puck.getTemperature()', function(temp) {
        tempInF = (temp.toFixed(2) * (9/5)) + 32;
        elements.temperature.setValue(tempInF);
    });
    
    Puck.eval("steps", function(d) {
       elements.steps.setValue(d);
    });
    
    Puck.eval("daily_average", function(avg) {
        elements.daily_avg.setValue(avg);
    });

    Puck.eval("seven_day_steps", function(daily_s) {
         elements.daily_steps.setData(daily_s);
       });

     Puck.eval("seven_day_active_mins", function(daily_s) {
         elements.daily_active_mins.setData(daily_s);
       });

     Puck.eval("hourly_steps", function(daily_s) {
         elements.hourly_steps.setData(daily_s);
       });

   }
   
   function connectDevice() {
    // connect, and ask for the battery percentage
    Puck.eval("{bat:E.getBattery()}", function(d, err) {
     if (!d) {
      alert("Web Bluetooth connection failed!\n"+(err||""));
      return;
     }
     // remove the 'connect' window
     elements.modal.remove();
     elements.bat.setValue(d.bat);

     // getSteps();
     setInterval(getActandTemp, 5000);
      });
   }
   // Set up the controls we see on the screen    
   var elements = {
    heading : TD.label({x:10,y:10,width:390,height:50,label:"PetBit Dashboard üêæ"}),
    steps : TD.gauge({x:10,y:70,width:190,height:220,label:"Today's Steps",value:0,min:0,max:10000}),
    activity : TD.gauge({x:210,y:70,width:190,height:220,label:"Today's Active Minutes",value:0,min:0,max:1440}),
    daily_avg : TD.gauge({x:410,y:70,width:190,height:220,label:"Daily Average Steps",value:0,min:0,max:10000}),
    bat : TD.gauge({x:510,y:70,width:190,height:220,label:"Battery %",value:0}),
    hourly_steps : TD.graph({x:10,y:300,width:400,height:300,label:"Hourly Steps", gridy:10, gridx:24}), 
    daily_steps : TD.graph({x:410,y:300,width:400,height:300,label:"Daily Steps", gridy:10, gridx:7}),
    daily_active_mins : TD.graph({x:10,y:610,width:400,height:180,label:"Daily Active Minutes", gridy:10, gridx:7}),
    //temperature : TD.value({x:210,y:300,width:190,height:50,label:"Temperature ¬∞F",value:0}),
    modal : TD.modal({x:10,y:10,width:600,height:350,label:"Click to connect",onchange:connectDevice})
  }

   // Add a comment
   for (var i in elements)
    document.body.appendChild(elements[i]);
  </script>
 </body>
</html>
