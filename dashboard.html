<html>
 <head>
  <title style="color: #252627;">PetBit Dashboard üêæ</title>
  <meta name="viewport" content="width=620, initial-scale=1">
 </head>
 <body style="width:620px;height:450px">
  <link href="https://espruino.github.io/TinyDash/tinydash.css" rel="stylesheet">
  <script src="https://espruino.github.io/TinyDash/tinydash.js"></script>
  <script src="https://www.puck-js.com/puck.js"></script>  
  <script>
   daily_gridy = 50;
   day = 0;
   device_connected = false;
   getActivityIntervalID = 0;
   updateDayIntervalID = 0;
   updateBatIntervalID = 0;

   function arrayToHoursLabel(data) {
       if (data.length !== 24) {
        throw new Error('Array must contain exactly 24 elements.');
        console.log(data);
       }
   
       return data.map((value, index) => {
           if (value !== 0) {
               // Apply AM/PM formatting based on the index
               if (index <= 12) {
                   return index === 0 ? `12am : ${value}` : `${index}am : ${value}`; // Special handling for midnight as 12 AM
               } else {
                   return `${index - 12}pm : ${value}`;
               }
           }
           return null;
       }).filter(item => item !== null).join(', ');
   }   

   function formatWeekData(data, currentDayIndex) {

       if (data.length !== 7) {
           throw new Error('Array must contain exactly 7 elements.');
       }

       if (currentDayIndex > 6)
           currentDayIndex = 6;
    
       const today = new Date();
       const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       let results = [];
   
       for (let index = 0; index <= currentDayIndex; index++) {
           // Calculate the date for each entry
           let dateOfEntry = new Date(today);
           dateOfEntry.setDate(today.getDate() - (currentDayIndex - index));
   
           // Format the date as "MON-DD"
           let month = months[dateOfEntry.getMonth()]; // Use the array to get the month abbreviation
           let day = dateOfEntry.getDate();
           let dateString = `${month}-${day.toString().padStart(2, '0')}`;
   
           if (data[index] != 0)
               results.push(`${dateString}: ${data[index]}`);
       }
   
       return results.join(', ');
   }
   
   function updateDay() {
    Puck.eval("day", function(d) {
         day = d;
         console.log('Day' + day);
      });
   } 

   function updateBat() {
     Puck.eval("{bat:E.getBattery()}", function(d, err) {
         elements.bat.setValue(d.bat);
     });
   }

   function getActivityv2() {
     Puck.eval("{data:returnLog()}", function (d) {
          
          let return_data = JSON.parse(d.data);
          console.log(return_data);
        
          elements.activity.setValue(return_data.active_min);
          elements.steps.setValue(return_data.steps);
          elements.daily_avg.setValue(return_data.daily_average);
          elements.daily_avg_mins.setValue(return_data.daily_average_active_mins);
          elements.daily_steps.setData(return_data.seven_day_steps);
          elements.daily_label.setValue(formatWeekData(return_data.seven_day_steps, day-1));
          elements.daily_active_mins.setData(return_data.seven_day_active_mins);
          elements.daily_mins_label.setValue(formatWeekData(return_data.seven_day_active_mins, day-1));
          elements.hourly_steps.setData(return_data.hourly_steps);
          elements.hourly_label.setValue(arrayToHoursLabel(return_data.hourly_steps));
     });
   }

   function disconnectDevice() {
        clearInterval(getActivityIntervalID);
        clearInterval(updateDayIntervalID);
        clearInterval(updateBatIntervalID); 
        Puck.close();
        document.body.appendChild(elements.modal);
   }

   function connectDevice(d, err) {
          if (!d) {
            console.log("Web Bluetooth connection failed!\n"+(err||""));
            alert("Connection failed! Please try again!!");
            return;
          }
          // remove the 'connect' window
          elements.modal.remove();
          device_connected = true;
          elements.bat.setValue(d.bat);
          Puck.eval("myDate.toString()", function(d) {
              elements.heading.setValue(d);
          });
     
          updateDay();
          // getSteps();
          getActivityIntervalID = setInterval(getActivityv2, 2000);
          updateDayIntervalID = setInterval(updateDay, 1000*60*15);
          updateBatIntervalID = setInterval(updateBat, 1000*60);
   }
   
   function onConnectDevice() {
      // connect, and ask for the battery percentage
      console.log("connect Device");
      Puck.eval("{bat:E.getBattery()}", connectDevice );    
   }
   
   // Set up the controls we see on the screen    
   var elements = {
    heading :   TD.value({x:10,y:10,width:390,height:80,label:"PetBit Dashboard üêæ Version 2.5", value:0}),
    bat :       TD.value({x:410,y:10,width:190,height:80,label:"Battery %",value:0}),
    disconnect: TD.button({x:610,y:10,width:190,height:80,label:"Disconnect",onchange:disconnectDevice}),
    steps :     TD.gauge({x:10,y:100,width:190,height:220,label:"Today's Steps",value:0,min:0,max:10000}),
    activity :  TD.gauge({x:210,y:100,width:190,height:220,label:"Today's Active Minutes",value:0,min:0,max:1440}),
    daily_avg : TD.gauge({x:410,y:100,width:190,height:220,label:"Daily Average Steps",value:0,min:0,max:1440}),
    daily_avg_mins : TD.gauge({x:610,y:100,width:190,height:220,label:"Daily Average Minutes",value:0,min:0,max:1440}),
    hourly_steps :   TD.graph({x:10,y:330,width:800,height:300,label:"Hourly Steps", gridy:daily_gridy}), 
    hourly_label:    TD.value({x:10,y:630,width:800,height:50,label:"Hourly Steps", value:" "}),
    daily_steps :       TD.graph({x:10,y:690,width:400,height:300,label:"Daily Steps", gridy:daily_gridy}),
    daily_active_mins : TD.graph({x:410,y:690,width:400,height:300,label:"Daily Active Minutes", gridy:daily_gridy}),
    daily_label:      TD.value({x:10,y:990,width:400,height:100,label:"Daily Steps", value:" " }),
    daily_mins_label: TD.value({x:410,y:990,width:400,height:100,label:"Daily Active Minutes", value:" "}),
    //temperature : TD.value({x:210,y:300,width:190,height:50,label:"Temperature ¬∞F",value:0}),
    modal : TD.modal({x:10,y:10,width:600,height:350,label:"Click to connect",onchange:onConnectDevice})

  }

   // Add a comment
   for (var i in elements)
     document.body.appendChild(elements[i]);
  </script>
 </body>
</html>
